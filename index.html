<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Check-in Rendszer | Dolgoz√≥i Fel√ºlet</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* A kor√°bbi st√≠lusok v√°ltoz√≥k, sz√≠nek, alap-body st√≠lus √©s desktop n√©zet (min-width: 769px) v√°ltozatlanok maradnak. */
        :root {
            --color-primary: #1e7e34; /* S√∂t√©tz√∂ld */
            --color-primary-light: #4caf50; /* Vil√°gosabb z√∂ld (Success) */
            --color-background: #f8f9fa; /* Vil√°gossz√ºrke h√°tt√©r */
            --color-white: #ffffff;
            --color-text-dark: #212529;
            --color-error: #dc3545; /* Piros (Error) */
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px; /* Alap padding */
            background-color: var(--color-background);
            color: var(--color-text-dark);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .layout-container {
            width: 100%;
            max-width: 1000px;
            margin: 20px 0;
            display: flex;
            gap: 30px;
            /* **FONTOS M√ìDOS√çT√ÅS:** Enged√©lyezi a t√∂rdel√©st kisebb k√©perny≈ëk√∂n */
            flex-wrap: wrap; 
            justify-content: center;
        }

        .panel {
            flex: 1;
            min-width: 300px;
            background-color: var(--color-white);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: var(--color-primary);
            font-weight: 700;
            border-bottom: 3px solid var(--color-primary-light);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 30px;
            font-size: 1.8rem; 
        }
        
        h2 {
            color: var(--color-text-dark);
            font-weight: 500;
            font-size: 1.3rem;
            margin-top: 0;
            margin-bottom: 15px;
        }

        /* QR Olvas√≥ panel st√≠lusa */
        #qr-video {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border: 2px solid #ccc;
            border-radius: 8px;
            background-color: #000;
        }

        /* √úzenetdobozok √©s √Ållapot panel st√≠lusok v√°ltozatlanok */
        .message-box { /* ... */ }
        .message-box.success { /* ... */ }
        .message-box.error { /* ... */ }
        #status-display { /* ... */ }
        #status-display p { /* ... */ }
        #status-display strong { /* ... */ }
        
        /* ------------------------------------------------------------------ */
        /* √öJ RESZPONZ√çV SZAB√ÅLYOK (MOBIL)                  */
        /* ------------------------------------------------------------------ */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px; /* Kisebb k√ºls≈ë padding */
            }
            .layout-container {
                gap: 20px;
                margin: 0;
                /* **LEGFONTOSABB V√ÅLTOZ√ÅS:** A panelek egym√°s al√° ker√ºlnek */
                flex-direction: column; 
            }
            .panel {
                min-width: unset; /* Nincs minimum sz√©less√©g, elfoglalja a rendelkez√©sre √°ll√≥ helyet */
                width: 100%;
                padding: 20px; /* Kisebb bels≈ë padding mobilra */
            }
            h1 {
                font-size: 1.5rem; /* Kicsit kisebb f≈ëc√≠m mobilra */
                margin-bottom: 20px;
            }
            #qr-video {
                height: 250px; /* Kisebb olvas√≥ablak mobil n√©zetben */
            }
            
            /* T√°bl√°zat fejl√©cek helyett blokk-elemk√©nt viselkednek mobilra, ha a tartalom nem f√©rne el. */
            /* B√°r ezt a list√°s n√©zetet a bonyolultabb admin.html-hez javaslom, itt el√©g az egyszer≈±s√≠t√©s: */
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead tr {
                position: absolute;
                top: -9999px; /* Elt√ºnteti az ism√©tl≈ëd≈ë oszlopneveket */
                left: -9999px;
            }
            tr { 
                border: 1px solid #ccc; 
                margin-bottom: 5px;
            }
            td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%; 
                text-align: right;
            }
            td:before {
                position: absolute;
                top: 6px;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 500;
                color: var(--color-primary);
            }
            
            /* Adatok hozz√°rendel√©se a :before tartalomhoz (ez a mobilon a "fejl√©c") */
            #history-body tr td:nth-of-type(1):before { content: "D√°tum:"; }
            #history-body tr td:nth-of-type(2):before { content: "Akci√≥:"; }
            #history-body tr td:nth-of-type(3):before { content: "Egys√©g:"; }

            /* Vissza√°ll√≠tjuk a norm√°lis t√°bl√°zat-megjelen√≠t√©st az √°llapot panelhez */
            #status-display + h2 + table {
                 display: table;
            }
        }
    </style>
</head>
<body onload="initializePage()">

<div class="layout-container">
    
    <div class="panel">
        <h1>üì∏ QR K√≥d Bejelentkez√©s</h1>
        
        <p>K√©rj√ºk, tartsa az egys√©g QR-k√≥dj√°t a kamera el√© a be- vagy kijelentkez√©shez.</p>
        
        <video id="qr-video"></video>

        <div id="result-message" class="message-box success" style="display:none;">
            Sikeres bejelentkez√©s!
        </div>

        <div id="error-message" class="message-box error" style="display:none;">
            Hiba t√∂rt√©nt. K√©rem pr√≥b√°lja √∫jra.
        </div>
    </div>
    
    <div class="panel">
        <h1>üë§ Aktu√°lis St√°tusz</h1>
        
        <div id="status-display">
            <h2>Dolgoz√≥: <span id="employee-name">Nincs beazonos√≠tva</span></h2>
            <p><strong>Egys√©g:</strong> <span id="unit-name">Nincs</span></p>
            <p><strong>Legut√≥bbi Akci√≥:</strong> <span id="last-action">Nincs</span></p>
            <p><strong>St√°tusz:</strong> <span id="checkin-status" style="color: var(--color-error); font-weight: 700;">KIJELENTKEZVE</span></p>
        </div>

        <h2>Munkamenet El≈ëzm√©nyek</h2>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #f0f0f0;">
                    <th style="padding: 10px; border-bottom: 1px solid #ccc; text-align: left;">D√°tum</th>
                    <th style="padding: 10px; border-bottom: 1px solid #ccc; text-align: left;">Akci√≥</th>
                    <th style="padding: 10px; border-bottom: 1px solid #ccc; text-align: left;">Egys√©g</th>
                </tr>
            </thead>
            <tbody id="history-body">
                <tr><td colspan="3" style="text-align: center; padding: 10px;">Az el≈ëzm√©nyek a bejelentkez√©s ut√°n jelennek meg.</td></tr>
            </tbody>
        </table>
    </div>

</div>

<script src="https://unpkg.com/qrcodescan@1.0.0/dist/qrcodescan.min.js"></script>
<script>
    // --- KONFIGUR√ÅCI√ìS ADATOK (V√°ltozatlanul) ---
    const CHECKIN_DATA_KEY = 'work_sessions';
    const CURRENT_EMPLOYEE_KEY = 'current_employee_id';

    const RESTAURANT_LOCATIONS = {
        'EGE': { name: 'Eger', lat: 47.9072155, lon: 20.3880078 },
        'PAK': { name: 'P√°kozd/M7', lat: 47.1685, lon: 18.5995 },
        'ALLEE': { name: 'Allee', lat: 47.4725, lon: 19.0498 },
        'VES': { name: 'Veszpr√©m', lat: 47.0945, lon: 17.9069 },
        'SZE': { name: 'Sz√©kesfeh√©rv√°r', lat: 47.1895, lon: 18.4208 }
    };

    const EMPLOYEE_DATA = [
        { id: 'EGE_001', name: 'Magyar Marcell', unit: 'EGE' },
        { id: 'EGE_006', name: 'Jo√≥ Krist√≥f S√°ndor', unit: 'EGE' },
        { id: 'EGE_007', name: 'Balogh M√°rk', unit: 'EGE' },
        { id: 'EGE_008', name: 'Mur√°nyi M√°t√©', unit: 'EGE' },
        { id: 'EGE_009', name: 'M√©sz√°ros M√°t√©', unit: 'EGE' },
        { id: 'EGE_010', name: 'Berkes Marcell', unit: 'EGE' },
        { id: 'EGE_011', name: 'B√©csi J√≥zsef S√°ndor', unit: 'EGE' },
        { id: 'EGE_012', name: 'Bartos Kitti Lili', unit: 'EGE' },
        { id: 'EGE_013', name: 'Guly√°s Blanka Vikt√≥ria', unit: 'EGE' },
        { id: 'EGE_014', name: 'Deli Dorina', unit: 'EGE' },
        { id: 'PAK_002', name: 'B√≥bis Csenge √Ågnes', unit: 'PAK' },
        { id: 'ALLEE_003', name: 'Meretei Bence', unit: 'ALLEE' },
        { id: 'VES_004', name: 'Varga T√≠mea', unit: 'VES' },
        { id: 'SZE_005', name: 'Hrankai Dominik', unit: 'SZE' },
        { id: 'PAK_015', name: 'Nagy Anna', unit: 'PAK' }
    ];

    const EMPLOYEE_MAP = EMPLOYEE_DATA.reduce((map, employee) => {
        map[employee.id] = employee;
        return map;
    }, {});

    // --- JavaScript Logika (V√°ltozatlanul) ---
    
    function getCurrentHungarianTime() {
        const now = new Date();
        const options = {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit',
            hour12: false
        };
        // A kimenet form√°tuma: dd. mm. yyyy, HH:MM:SS
        return now.toLocaleDateString('hu-HU', options).replace(/\./g, '').replace(/ /g, '. ') + ', ' + now.toLocaleTimeString('hu-HU', options);
    }
    
    let qrScan;
    
    function initializePage() {
        startQrScanner();
        updateStatusDisplay(localStorage.getItem(CURRENT_EMPLOYEE_KEY));
    }
    
    function startQrScanner() {
        const videoElement = document.getElementById('qr-video');
        
        qrScan = new QrCodeScan(videoElement, (result) => {
            if (result) {
                qrScan.stop();
                handleQrCodeResult(result);
            }
        });

        qrScan.start().catch(error => {
            document.getElementById('error-message').innerText = 'Hiba a kamera el√©r√©s√©ben. K√©rem ellen≈ërizze a jogosults√°gokat.';
            showMessage('error');
            console.error(error);
        });
    }

    function handleQrCodeResult(scannedData) {
        const employeeId = scannedData.trim();
        const employee = EMPLOYEE_MAP[employeeId];
        
        if (!employee) {
            document.getElementById('error-message').innerText = `Hiba: Ismeretlen dolgoz√≥i azonos√≠t√≥: ${employeeId}`;
            showMessage('error');
            setTimeout(startQrScanner, 3000);
            return;
        }

        let sessions = JSON.parse(localStorage.getItem(CHECKIN_DATA_KEY) || '[]');
        const isCurrentlyCheckedIn = sessions.filter(s => s.id === employeeId && s.type === 'BEJELENTKEZ√âS').length % 2 !== 0;

        const actionType = isCurrentlyCheckedIn ? 'KIJELENTKEZ√âS' : 'BEJELENTKEZ√âS';
        const newEntry = {
            id: employeeId,
            name: employee.name,
            unit: employee.unit,
            type: actionType,
            timestamp: getCurrentHungarianTime()
        };

        sessions.push(newEntry);
        localStorage.setItem(CHECKIN_DATA_KEY, JSON.stringify(sessions));

        if (actionType === 'BEJELENTKEZ√âS') {
            localStorage.setItem(CURRENT_EMPLOYEE_KEY, employeeId);
            document.getElementById('result-message').innerText = `${employee.name} sikeresen BEJELENTKEZETT (Egys√©g: ${RESTAURANT_LOCATIONS[employee.unit].name})!`;
        } else {
            localStorage.removeItem(CURRENT_EMPLOYEE_KEY);
            document.getElementById('result-message').innerText = `${employee.name} sikeresen KIJELENTKEZETT! J√≥ munk√°t/pihen√©st!`;
        }
        
        showMessage('success');
        updateStatusDisplay(employeeId);
        
        setTimeout(startQrScanner, 3000);
    }

    function showMessage(type) {
        document.getElementById('result-message').style.display = 'none';
        document.getElementById('error-message').style.display = 'none';
        
        if (type === 'success') {
            document.getElementById('result-message').style.display = 'block';
        } else if (type === 'error') {
            document.getElementById('error-message').style.display = 'block';
        }
        
        setTimeout(() => {
            document.getElementById('result-message').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
        }, 3000);
    }
    
    function updateStatusDisplay(employeeId) {
        const nameEl = document.getElementById('employee-name');
        const unitEl = document.getElementById('unit-name');
        const lastActionEl = document.getElementById('last-action');
        const statusEl = document.getElementById('checkin-status');
        const historyBody = document.getElementById('history-body');

        if (!employeeId) {
            nameEl.textContent = 'Nincs beazonos√≠tva';
            unitEl.textContent = 'Nincs';
            lastActionEl.textContent = 'Nincs';
            statusEl.textContent = 'KIJELENTKEZVE';
            statusEl.style.color = 'var(--color-error)';
            historyBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 10px;">Jelentkezzen be az adatai megjelen√≠t√©s√©hez.</td></tr>';
            return;
        }

        const employee = EMPLOYEE_MAP[employeeId];
        const sessions = JSON.parse(localStorage.getItem(CHECKIN_DATA_KEY) || '[]');
        const employeeSessions = sessions.filter(s => s.id === employeeId);
        
        const isCheckedIn = employeeSessions.length % 2 !== 0;

        nameEl.textContent = employee.name;
        unitEl.textContent = RESTAURANT_LOCATIONS[employee.unit].name;
        
        const lastEntry = employeeSessions[employeeSessions.length - 1];

        if (lastEntry) {
            lastActionEl.textContent = `${lastEntry.type} (${lastEntry.timestamp.substring(12)})`;
        } else {
            lastActionEl.textContent = 'M√©g nem volt akci√≥';
        }

        if (isCheckedIn) {
            statusEl.textContent = 'BEJELENTKEZVE';
            statusEl.style.color = 'var(--color-primary)';
        } else {
            statusEl.textContent = 'KIJELENTKEZVE';
            statusEl.style.color = 'var(--color-error)';
        }
        
        // El≈ëzm√©nyek felt√∂lt√©se
        historyBody.innerHTML = '';
        if (employeeSessions.length > 0) {
            employeeSessions.slice(-10).reverse().forEach(entry => { // Utols√≥ 10 esem√©ny
                const row = historyBody.insertRow();
                row.insertCell().textContent = entry.timestamp.substring(0, 10); // D√°tum
                row.insertCell().textContent = entry.type;
                row.insertCell().textContent = RESTAURANT_LOCATIONS[entry.unit].name;
            });
        } else {
            historyBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 10px;">Nincs r√∂gz√≠tett el≈ëzm√©ny.</td></tr>';
        }
    }
</script>
</body>
</html>

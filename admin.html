<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Check-in Rendszer | ADMIN Menedzser Fel√ºlet</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ADMIN ST√çLUSOK */
        :root {
            --color-primary: #1e7e34;
            --color-background: #f8f9fa;
            --color-white: #ffffff;
            --color-text-dark: #212529;
            --color-error: #dc3545;
            --color-success: #4caf50;
            --color-primary-light: #4caf50;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 40px;
            background-color: var(--color-background);
            color: var(--color-text-dark);
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background-color: var(--color-white);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        h1 {
            color: var(--color-primary);
            font-weight: 500;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Sz≈±r√©si vez√©rl≈ë st√≠lusa */
        .filter-control {
            margin-top: 15px;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background-color: #fcfcfc;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-control label {
            font-weight: 500;
            margin-right: 10px;
            display: block;
            margin-bottom: 5px;
            color: var(--color-primary);
        }

        .filter-control select, .filter-control input[type="date"] {
            padding: 10px;
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 1rem;
            background-color: var(--color-white);
            box-sizing: border-box;
        }

        /* C√çM √âS EXPORT GOMB T√ÅROL√ì */
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        /* EXPORT GOMB ST√çLUS */
        #exportCsvButton {
            background-color: #007bff;
            color: var(--color-white);
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #exportCsvButton:hover {
            background-color: #0056b3;
        }


        /* √ìrasz√°mok Null√°z√°sa gomb st√≠lusa */
        #resetHoursButton {
            background-color: var(--color-error);
            color: var(--color-white);
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #resetHoursButton:hover {
            background-color: #c82333;
        }

        /* T√°bl√°zat st√≠lusok */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            margin-top: 20px;
        }

        .admin-table th, .admin-table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        .admin-table th {
            background-color: #e9ecef;
            font-weight: 500;
            color: var(--color-text-dark);
            text-transform: uppercase;
        }

        .admin-table tr.checked-in-row {
            background-color: #e6ffed;
            font-weight: 500;
        }

        .status-dot {
            height: 10px;
            width: 10px;
            background-color: var(--color-error);
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-dot.checked-in {
            background-color: var(--color-success);
        }

        /* R√©szletes Napl√≥ St√≠lusa */
        #detailedLogSection h2 {
            color: var(--color-primary);
            font-weight: 500;
        }

        .detailed-table th {
            background-color: var(--color-primary-light);
            color: var(--color-white);
        }

        .detailed-table tr.active-log {
            background-color: #fff8e1;
            font-weight: 500;
        }


        /* MOD√ÅLIS ST√çLUSOK */
        .modal {
            display: none;
            position: fixed;
            z-index: 20;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: var(--color-white);
            margin: 15% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }

        .modal-content h2 {
            color: var(--color-error);
            font-weight: 700;
            margin-top: 0;
        }

        .modal-content p {
            margin-bottom: 30px;
            color: var(--color-text-dark);
        }

        .modal-buttons {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
        }

        #modalConfirm {
            background-color: var(--color-error);
            color: var(--color-white);
        }

        #modalConfirm:hover {
            background-color: #c82333;
        }

        #modalCancel {
            background-color: #e9ecef;
            color: var(--color-text-dark);
        }

        #modalCancel:hover {
            background-color: #dee2e6;
        }
    </style>
</head>
<body onload="initializeAdminPanel()">

<div class="container">
    
    <h1>
        <span>üìä Adminisztr√°ci√≥s Munkaid≈ë √ñsszes√≠t√©s</span>
        
        <button id="resetHoursButton" onclick="openResetModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 3a5 5 0 0 0-4.546 2.914.5.5 0 0 1-.9.377 6 6 0 1 1 13.626 4.91.5.5 0 0 1-.904-.413A5 5 0 1 0 8 3z"/>
                <path d="M8 10V5h1v4h4v1z"/>
            </svg>
            √ñsszes adat t√∂rl√©se
        </button>
    </h1>
    
    <p>A t√°bl√°zat a dolgoz√≥k teljes munkaidej√©t √©s az aktu√°lis bejelentkez√©si st√°tuszukat mutatja a sz≈±r√©si felt√©telek alapj√°n.</p>
    
    <div class="filter-control">
        <div class="filter-group">
            <label for="adminCitySelect">Sz≈±r√©s Egys√©g Szerint:</label>
            <select id="adminCitySelect" onchange="updateAdminPanel()">
                <option value="ALL">√ñsszes egys√©g</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="startDate">Kezd≈ë d√°tum:</label>
            <input type="date" id="startDate" onchange="updateAdminPanel()">
        </div>
        
        <div class="filter-group">
            <label for="endDate">Z√°r√≥ d√°tum:</label>
            <input type="date" id="endDate" onchange="updateAdminPanel()">
        </div>
    </div>

    <h2>√ñsszes√≠tett Munka√≥r√°k</h2>
    <table class="admin-table">
        <thead>
            <tr>
                <th>Dolgoz√≥</th>
                <th>Egys√©g</th>
                <th>St√°tusz</th>
                <th>√ñssz. id≈ë (√≥ra)</th>
            </tr>
        </thead>
        <tbody id="adminTableBody">
            </tbody>
    </table>
    
    <div id="detailedLogSection">
        <div class="log-header">
              <h2>R√©szletes Be- √©s Kijelentkez√©si Napl√≥</h2>
              <button id="exportCsvButton" onclick="exportDetailedLogToCSV()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a.5.5 0 0 0 .5.5h12a.5.5 0 0 0 .5-.5v-2.5a.5.5 0 0 1 1 0v2.5a1.5 1.5 0 0 1-1.5 1.5h-12A1.5 1.5 0 0 1 0 12.9v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
                CSV Export (sz≈±rt adatok)
            </button>
        </div>
        
        <p id="logFilterStatus"></p>
        <table class="admin-table detailed-table">
            <thead>
                <tr>
                    <th>D√°tum</th>
                    <th>Dolgoz√≥</th>
                    <th>Egys√©g</th>
                    <th>Bejelentkez√©s ideje (HH:MM:SS)</th>
                    <th>Kijelentkez√©s ideje (HH:MM:SS)</th>
                    <th>Munkamenet Id≈ë</th>
                    <th>St√°tusz</th>
                </tr>
            </thead>
            <tbody id="detailedLogBody">
            </tbody>
        </table>
    </div>
    
    <p style="margin-top: 20px; color: var(--color-error); font-weight: 500;" id="adminStatusMessage"></p>
</div>


<div id="resetModal" class="modal">
    <div class="modal-content">
        <h2>‚ö†Ô∏è Er≈ëteljes M≈±velet Figyelmeztet√©s ‚ö†Ô∏è</h2>
        <p>Ezzel a m≈±velettel az ùó¢Ãàùó¶ùó¶ùó≠ùóòùó¶ be- √©s kijelentkez√©si ùóòùó¶ùóòùó†ùóòÃÅùó°ùó¨ ùòÅùóºÃàùóøùóπùóºÃàùó±ùó∂ a helyi t√°rol√≥b√≥l!</p>
        <p>Biztosan folytatni k√≠v√°nja?</p>
        <div class="modal-buttons">
            <button id="modalConfirm" onclick="performReset()">T√∂rl√©s meger≈ës√≠t√©se</button>
            <button id="modalCancel" onclick="closeResetModal()">M√©gsem</button>
        </div>
    </div>
</div>

<script>
    // --- KONFIGUR√ÅCI√ìS ADATOK (Az index.html-b≈ël sz√°rmaz√≥ adatok) ---
    
    const CHECKIN_DATA_KEY = 'work_sessions'; // A dolgoz√≥i oldallal egyez≈ë kulcs!

    const RESTAURANT_LOCATIONS = {
        'EGE': { name: 'Eger', lat: 47.9072155, lon: 20.3880078 },
        'PAK': { name: 'P√°kozd/M7', lat: 47.1685, lon: 18.5995 },
        'ALLEE': { name: 'Allee', lat: 47.4725, lon: 19.0498 },
        'VES': { name: 'Veszpr√©m', lat: 47.0945, lon: 17.9069 },
        'SZE': { name: 'Sz√©kesfeh√©rv√°r', lat: 47.1895, lon: 18.4208 }
    };

    const EMPLOYEE_DATA = [
        { id: 'EGE_001', name: 'Magyar Marcell', unit: 'EGE' },
        { id: 'EGE_006', name: 'Jo√≥ Krist√≥f S√°ndor', unit: 'EGE' },
        { id: 'EGE_007', name: 'Balogh M√°rk', unit: 'EGE' },
        { id: 'EGE_008', name: 'Mur√°nyi M√°t√©', unit: 'EGE' },
        { id: 'EGE_009', name: 'M√©sz√°ros M√°t√©', unit: 'EGE' },
        { id: 'EGE_010', name: 'Berkes Marcell', unit: 'EGE' },
        { id: 'EGE_011', name: 'B√©csi J√≥zsef S√°ndor', unit: 'EGE' },
        { id: 'EGE_012', name: 'Bartos Kitti Lili', unit: 'EGE' },
        { id: 'EGE_013', name: 'Guly√°s Blanka Vikt√≥ria', unit: 'EGE' },
        { id: 'EGE_014', name: 'Deli Dorina', unit: 'EGE' },
        { id: 'PAK_002', name: 'B√≥bis Csenge √Ågnes', unit: 'PAK' },
        { id: 'ALLEE_003', name: 'Meretei Bence', unit: 'ALLEE' },
        { id: 'VES_004', name: 'Varga T√≠mea', unit: 'VES' },
        { id: 'SZE_005', name: 'Hrankai Dominik', unit: 'SZE' },
        { id: 'PAK_015', name: 'Nagy Anna', unit: 'PAK' }
    ];
    
    // Seg√©dt√©rk√©p a dolgoz√≥k gyors el√©r√©s√©hez
    const EMPLOYEE_MAP = EMPLOYEE_DATA.reduce((map, employee) => {
        map[employee.id] = employee;
        return map;
    }, {});

    // --- SEG√âDF√úGGV√âNYEK ---

    /**
     * √Åtalak√≠tja a 'dd. mm. yyyy, hh:mm:ss' stringet Date objektumm√°.
     * @param {string} timestampStr - 'dd. mm. yyyy, hh:mm:ss' form√°tum√∫ id≈ëb√©lyeg.
     * @returns {Date | null} A megfelel≈ë Date objektum, vagy null hiba eset√©n.
     */
    function parseHungarianTimestamp(timestampStr) {
        if (!timestampStr) return null;
        try {
            // P√©lda: "14. 12. 2025, 15:00:00"
            const [datePart, timePart] = timestampStr.split(', ');
            const [day, month, year] = datePart.split('. ').map(s => parseInt(s.trim(), 10));
            // A h√≥nap nulla alap√∫ a Date konstruktorban
            return new Date(year, month - 1, day, ...timePart.split(':').map(s => parseInt(s.trim(), 10)));
        } catch (e) {
            console.error("Hiba az id≈ëb√©lyeg konvert√°l√°sakor:", timestampStr, e);
            return null;
        }
    }
    
    /**
     * K√©t id≈ëpont k√∂z√∂tti elt√©r√©st sz√°molja ki HH:MM:SS form√°tumban.
     * @param {Date} start - Kezd≈ë d√°tum
     * @param {Date} end - Z√°r√≥ d√°tum
     * @returns {string} HH:MM:SS form√°tum√∫ id≈ëtartam
     */
    function formatDuration(start, end) {
        if (!start || !end) return 'Akt√≠v munkamenet';
        
        const diffMs = end.getTime() - start.getTime();
        const diffSec = Math.floor(diffMs / 1000);
        
        const hours = Math.floor(diffSec / 3600);
        const minutes = Math.floor((diffSec % 3600) / 60);
        const seconds = diffSec % 60;

        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    /**
     * Konvert√°lja a HH:MM:SS stringet √≥ra tizedes form√°tumra.
     * @param {string} durationStr - HH:MM:SS
     * @returns {number} √ìra tizedes form√°tumban
     */
    function durationToHours(durationStr) {
        const parts = durationStr.split(':');
        if (parts.length !== 3) return 0;
        
        const [h, m, s] = parts.map(Number);
        return h + (m / 60) + (s / 3600);
    }
    
    // --- ADATFELDOLGOZ√ì LOGIKA ---

    /**
     * Feldolgozza az √∂sszes esem√©nyt √©s aggreg√°lja az adatokat.
     * @returns {{ totalHoursByEmployee: Object, detailedLog: Array, activeSessions: Array }}
     */
    function processWorkSessions() {
        const sessionsRaw = JSON.parse(localStorage.getItem(CHECKIN_DATA_KEY) || '[]');
        const totalHoursByEmployee = {};
        const detailedLog = [];
        const activeSessions = {}; // { employeeId: { checkInEntry, checkInTimeDate } }

        sessionsRaw.forEach(entry => {
            const employeeId = entry.id;
            const entryTime = parseHungarianTimestamp(entry.timestamp);

            if (!employeeId || !entryTime) return; // √ârv√©nytelen bejegyz√©s kihagy√°sa

            // 1. √ñsszes√≠tett √ìr√°k / Akt√≠v Munkamenetek Kezel√©se
            if (entry.type === 'BEJELENTKEZ√âS') {
                // Kezd≈ëdik egy munkamenet
                activeSessions[employeeId] = {
                    checkInEntry: entry,
                    checkInTimeDate: entryTime
                };
            } else if (entry.type === 'KIJELENTKEZ√âS') {
                // Z√°rul egy munkamenet
                if (activeSessions[employeeId]) {
                    const startData = activeSessions[employeeId];
                    const durationStr = formatDuration(startData.checkInTimeDate, entryTime);
                    const durationHours = durationToHours(durationStr);

                    // Hozz√°adjuk a lez√°rt munkamenetet a r√©szletes napl√≥hoz
                    detailedLog.push({
                        id: employeeId,
                        name: entry.name,
                        unit: entry.unit,
                        date: startData.checkInTimeDate.toLocaleDateString('hu-HU', { year: 'numeric', month: '2-digit', day: '2-digit' }),
                        checkIn: startData.checkInEntry.timestamp,
                        checkOut: entry.timestamp,
                        durationStr: durationStr,
                        durationHours: durationHours,
                        isActive: false
                    });

                    // Hozz√°adjuk az √∂sszes√≠tett √≥r√°khoz
                    totalHoursByEmployee[employeeId] = (totalHoursByEmployee[employeeId] || 0) + durationHours;

                    // T√∂r√∂lj√ºk az akt√≠v munkamenetek k√∂z√ºl
                    delete activeSessions[employeeId];
                }
                // Ha nincs hozz√° bejelentkez√©s, figyelmen k√≠v√ºl hagyjuk a kijelentkez√©st,
                // de az admin fel√ºleten megjelenik az esem√©nylist√°ban (ha ki is l√©pn√©nek egyszer)
            }
        });

        // 2. Kezelj√ºk az Akt√≠v Munkameneteket (amikhez nem volt KIJELENTKEZ√âS)
        const now = new Date();
        const finalActiveSessions = [];
        
        for (const employeeId in activeSessions) {
            const startData = activeSessions[employeeId];
            const durationStr = formatDuration(startData.checkInTimeDate, now);
            const durationHours = durationToHours(durationStr);

            // Akt√≠v munkamenetet is hozz√°adjuk a r√©szletes napl√≥hoz
            detailedLog.push({
                id: employeeId,
                name: startData.checkInEntry.name,
                unit: startData.checkInEntry.unit,
                date: startData.checkInTimeDate.toLocaleDateString('hu-HU', { year: 'numeric', month: '2-digit', day: '2-digit' }),
                checkIn: startData.checkInEntry.timestamp,
                checkOut: 'AKTU√ÅLISAN BEJELENTKEZVE',
                durationStr: durationStr,
                durationHours: durationHours,
                isActive: true
            });
            
            // Hozz√°adjuk az akt√≠v √≥r√°kat is az √∂sszes√≠t√©shez
            totalHoursByEmployee[employeeId] = (totalHoursByEmployee[employeeId] || 0) + durationHours;
            
            // K√ºl√∂n lista az akt√≠v st√°tuszhoz
            finalActiveSessions.push({
                id: employeeId,
                name: startData.checkInEntry.name,
                unit: startData.checkInEntry.unit
            });
        }
        
        // A detailedLog rendez√©se id≈ëb√©lyeg szerint (leg√∫jabb alul)
        detailedLog.sort((a, b) => parseHungarianTimestamp(a.checkIn).getTime() - parseHungarianTimestamp(b.checkIn).getTime());


        return { totalHoursByEmployee, detailedLog, activeSessions: finalActiveSessions };
    }

    // --- SZ≈∞R√âS √âS FRISS√çT√âS LOGIKA ---

    function initializeAdminPanel() {
        populateAdminCities();
        updateAdminPanel();
    }

    function populateAdminCities() {
        const citySelect = document.getElementById('adminCitySelect');
        // '√ñsszes egys√©g' opci√≥ m√°r ott van a HTML-ben
        for (const code in RESTAURANT_LOCATIONS) {
            const city = RESTAURANT_LOCATIONS[code];
            const option = document.createElement('option');
            option.value = code;
            option.textContent = city.name;
            citySelect.appendChild(option);
        }
    }

    function updateAdminPanel() {
        const selectedUnitCode = document.getElementById('adminCitySelect').value;
        const startDateStr = document.getElementById('startDate').value;
        const endDateStr = document.getElementById('endDate').value;

        // Adatok feldolgoz√°sa
        const { totalHoursByEmployee, detailedLog, activeSessions } = processWorkSessions();

        // Akt√≠v dolgoz√≥k ID-ja (a gyors ellen≈ërz√©shez)
        const activeIds = activeSessions.map(s => s.id);
        
        // Sz≈±r≈ë felt√©telek el≈ëk√©sz√≠t√©se
        const filterStartDate = startDateStr ? new Date(startDateStr) : null;
        const filterEndDate = endDateStr ? new Date(endDateStr) : null;
        if (filterEndDate) {
             // A z√°r√≥ d√°tumot a nap v√©g√©re √°ll√≠tjuk (23:59:59)
            filterEndDate.setHours(23, 59, 59, 999);
        }

        // 1. √ñSSZES√çT≈ê T√ÅBL√ÅZAT FRISS√çT√âSE
        const summaryBody = document.getElementById('adminTableBody');
        summaryBody.innerHTML = '';
        
        // √ñsszes√≠tett √≥r√°k √∂sszes√≠t√©se dolgoz√≥/egys√©g szerint (sz≈±r√©s el≈ëtt)
        const aggregatedData = {};

        // √ñsszes dolgoz√≥t hozz√°adjuk az √∂sszes√≠t√©shez, m√©g ha 0 √≥r√°ja is van
        EMPLOYEE_DATA.forEach(employee => {
            const employeeId = employee.id;
            const employeeUnitCode = employee.unit;

            // Sz≈±r≈ë: egys√©g
            if (selectedUnitCode !== 'ALL' && employeeUnitCode !== selectedUnitCode) {
                return;
            }
            
            // Sz≈±r√©shez √∫jra kell aggreg√°lni a detailedLog-ot d√°tum alapj√°n,
            // de az egyszer≈±s√©g kedv√©√©rt most a teljes √≥r√°kat mutatjuk itt.
            
            const totalHours = totalHoursByEmployee[employeeId] || 0;

            const isCheckedIn = activeIds.includes(employeeId);
            const unitName = RESTAURANT_LOCATIONS[employeeUnitCode].name;
            
            aggregatedData[employeeId] = {
                name: employee.name,
                unit: unitName,
                totalHours: totalHours,
                isCheckedIn: isCheckedIn
            };
        });

        // T√ÅBL√ÅZAT KIT√ñLT√âSE (F≈ê √ñSSZES√çT√âS)
        for (const id in aggregatedData) {
            const data = aggregatedData[id];
            
            const row = summaryBody.insertRow();
            if (data.isCheckedIn) {
                row.classList.add('checked-in-row');
            }
            
            row.insertCell().textContent = data.name;
            row.insertCell().textContent = data.unit;
            
            const statusCell = row.insertCell();
            statusCell.innerHTML = `<span class="status-dot ${data.isCheckedIn ? 'checked-in' : ''}"></span> ${data.isCheckedIn ? 'Bejelentkezve' : 'Kijelentkezve'}`;
            
            row.insertCell().textContent = data.totalHours.toFixed(2);
        }


        // 2. R√âSZLETES NAPL√ì T√ÅBL√ÅZAT FRISS√çT√âSE
        const detailedBody = document.getElementById('detailedLogBody');
        detailedBody.innerHTML = '';
        
        let filteredLogCount = 0;
        let totalFilteredHours = 0;

        detailedLog.forEach(log => {
            const logDate = parseHungarianTimestamp(log.checkIn);
            if (!logDate) return;

            // Egys√©g sz≈±r√©s
            if (selectedUnitCode !== 'ALL' && EMPLOYEE_MAP[log.id].unit !== selectedUnitCode) {
                return;
            }

            // D√°tum sz≈±r√©s
            if (filterStartDate && logDate.getTime() < filterStartDate.getTime()) {
                return;
            }
            if (filterEndDate && logDate.getTime() > filterEndDate.getTime()) {
                // Megjegyz√©s: Ha a munkamenet √°th√∫z√≥dik a filterEndDate ut√°nra,
                // de a checkIn beleesik a tartom√°nyba, itt nem sz≈±rj√ºk ki.
            }
            
            // Sz≈±rt adatok ment√©se CSV exportra
            filteredLogCount++;
            if (!log.isActive) {
                 totalFilteredHours += log.durationHours;
            } else {
                 // Az akt√≠v munkamenet √≥r√°it nem sz√°moljuk bele a lez√°rt √∂sszes √≥r√°ba
            }
            
            const row = detailedBody.insertRow();
            if (log.isActive) {
                row.classList.add('active-log');
            }

            const datePart = log.checkIn.substring(0, 10);
            const checkInTime = log.checkIn.substring(12);
            const checkOutTime = log.checkOut === 'AKTU√ÅLISAN BEJELENTKEZVE' ? log.checkOut : log.checkOut.substring(12);
            
            row.insertCell().textContent = datePart;
            row.insertCell().textContent = log.name;
            row.insertCell().textContent = log.unit;
            row.insertCell().textContent = checkInTime;
            row.insertCell().textContent = checkOutTime;
            row.insertCell().textContent = log.durationStr;
            row.insertCell().textContent = log.isActive ? 'Akt√≠v' : 'Lez√°rva';
        });

        const filterStatusDiv = document.getElementById('logFilterStatus');
        if (filterStartDate && filterEndDate) {
            filterStatusDiv.textContent = `A r√©szletes napl√≥ a(z) ${filterStartDate.toLocaleDateString()} √©s ${filterEndDate.toLocaleDateString()} k√∂z√∂tti esem√©nyeket mutatja.`;
        } else if (filterStartDate) {
            filterStatusDiv.textContent = `A r√©szletes napl√≥ a(z) ${filterStartDate.toLocaleDateString()} ut√°ni esem√©nyeket mutatja.`;
        } else if (filterEndDate) {
            filterStatusDiv.textContent = `A r√©szletes napl√≥ a(z) ${filterEndDate.toLocaleDateString()} el≈ëtti esem√©nyeket mutatja.`;
        } else {
            filterStatusDiv.textContent = 'A r√©szletes napl√≥ az √∂sszes r√∂gz√≠tett be- √©s kijelentkez√©si esem√©nyt tartalmazza.';
        }


        if (filteredLogCount === 0) {
            const row = detailedBody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 7;
            cell.textContent = "Nincs r√∂gz√≠tett be- vagy kijelentkez√©si esem√©ny a sz≈±r√©si felt√©teleknek megfelel≈ëen.";
            cell.style.textAlign = 'center';
            cell.style.fontStyle = 'italic';
        }
        
        // Esem√©nyek export√°l√°s√°hoz t√°roljuk a sz≈±rt napl√≥t
        window.filteredDetailedLog = detailedLog.filter(log => {
            const logDate = parseHungarianTimestamp(log.checkIn);
            if (!logDate) return false;

            // Egys√©g sz≈±r√©s
            if (selectedUnitCode !== 'ALL' && EMPLOYEE_MAP[log.id].unit !== selectedUnitCode) {
                return false;
            }

            // D√°tum sz≈±r√©s
            if (filterStartDate && logDate.getTime() < filterStartDate.getTime()) {
                return false;
            }
            if (filterEndDate && logDate.getTime() > filterEndDate.getTime()) {
                // A checkIn-nek kell a d√°tumtartom√°nyban lennie
                return false;
            }
            return true;
        });

    }

    // --- CSV EXPORT ---

    function exportDetailedLogToCSV() {
        if (!window.filteredDetailedLog || window.filteredDetailedLog.length === 0) {
            alert("Nincs export√°lhat√≥ adat a jelenlegi sz≈±r√©si felt√©telek mellett.");
            return;
        }

        let csv = 'D√°tum;Dolgoz√≥;Egys√©g;Bejelentkez√©s ideje;Kijelentkez√©s ideje;Munkamenet Id≈ë;St√°tusz;Munkamenet Id≈ë (√≥ra tizedes)\n';

        window.filteredDetailedLog.forEach(log => {
            const datePart = log.checkIn.substring(0, 10);
            const checkInTime = log.checkIn.substring(12);
            const checkOutTime = log.checkOut === 'AKTU√ÅLISAN BEJELENTKEZVE' ? 'AKT√çV' : log.checkOut.substring(12);
            const status = log.isActive ? 'Akt√≠v' : 'Lez√°rva';
            const durationHours = log.isActive ? 'AKT√çV' : log.durationHours.toFixed(4).replace('.', ','); // CSV-ben a vessz≈ë az elv√°laszt√≥
            
            csv += `${datePart};"${log.name}";${log.unit};${checkInTime};${checkOutTime};${log.durationStr};${status};${durationHours}\n`;
        });

        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) { 
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            
            // D√°tum form√°z√°sa f√°jln√©vhez
            const today = new Date().toLocaleDateString('hu-HU').replace(/\. /g, '-').replace(/\.$/g, '');
            link.setAttribute("download", `munkaido-naplo-admin-${today}.csv`);
            
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else {
            alert("A b√∂ng√©sz≈ë nem t√°mogatja a k√∂zvetlen CSV let√∂lt√©st.");
        }
    }


    // --- ADAT T√ñRL√âSE (RESET) LOGIKA ---
    
    function openResetModal() {
        document.getElementById('resetModal').style.display = 'block';
    }

    function closeResetModal() {
        document.getElementById('resetModal').style.display = 'none';
    }

    function performReset() {
        localStorage.removeItem(CHECKIN_DATA_KEY);
        closeResetModal();
        alert('Az √∂sszes munkaid≈ë esem√©ny t√∂r√∂lve a helyi t√°rol√≥b√≥l!');
        updateAdminPanel();
    }
</script>

</body>
</html>
